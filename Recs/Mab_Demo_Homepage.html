<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MAB Demo – Server-side UCB (Single Variant per User)</title>
  <style>
    :root { --bg:#0b1420; --card:#0f1b2b; --muted:#9fb0c3; --text:#e7f1ff; --accent:#2ea0ff; --cta:#2ea0ff; --cta-text:#001224; --ring:rgba(46,160,255,.35); }
    .arm-B { --accent:#ff4d4f; --cta:#ff4d4f; --ring:rgba(255,77,79,.35); }
    .arm-C { --accent:#22c55e; --cta:#22c55e; --ring:rgba(34,197,94,.35); }

    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1200px 700px at 80% -10%,#19304c 0%,transparent 60%),radial-gradient(1200px 700px at 20% -10%,#11263e 0%,transparent 60%),var(--bg);color:var(--text)}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:16px}
    .logo{display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.4px}
    .logo-mark{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#7cc5ff);box-shadow:0 0 0 6px var(--ring)}
    nav a{opacity:.9;padding:10px 12px;border-radius:10px;color:inherit;text-decoration:none}
    nav a:hover{background:rgba(255,255,255,.06)}

    /* Hide switcher by default (student view); show only in teacher mode */
    .switcher{display:none;gap:10px;align-items:center;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);padding:6px;border-radius:999px}
    .pill{padding:8px 14px;border-radius:999px;font-weight:600;cursor:pointer;opacity:.8;border:1px solid transparent}
    .pill.active{background:var(--accent);color:var(--cta-text);opacity:1;box-shadow:0 0 0 6px var(--ring)}

    .hero{display:grid;grid-template-columns:1.2fr .8fr;gap:24px;align-items:center;padding:48px 0 24px}
    .hero-card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:24px;padding:36px;box-shadow:0 10px 50px rgba(0,0,0,.25);position:relative;overflow:hidden}
    .eyebrow{color:var(--muted);text-transform:uppercase;letter-spacing:.16em;font-size:.82rem}
    .title{font-size:clamp(2rem,4vw,3rem);line-height:1.05;margin:10px 0 6px}
    .subtitle{color:#c9d9ee;font-size:clamp(1rem,2vw,1.15rem);max-width:55ch}
    .cta-row{display:flex;gap:14px;align-items:center;margin-top:26px;flex-wrap:wrap}
    .btn-primary{background:var(--cta);color:var(--cta-text);border:none;padding:14px 18px;border-radius:14px;font-weight:700;cursor:pointer;box-shadow:0 8px 30px rgba(46,160,255,.25)}
    .btn-primary:hover{transform:translateY(-1px)}
    .btn-ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.18);padding:12px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    .badge{position:absolute;right:18px;top:18px;font-weight:800;font-size:.72rem;letter-spacing:.12em;padding:6px 10px;border-radius:999px;background:var(--accent);color:var(--cta-text);box-shadow:0 0 0 6px var(--ring)}

    .features{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin:28px 0 36px}
    .feature{background:#0f1b2b;border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:18px}
    .feature h4{margin:0 0 6px}
    .feature p{margin:0;color:#c7d6ea}

    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    .card{background:#0f1b2b;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px}
    .img{height:140px;border-radius:12px;background:linear-gradient(135deg,rgba(255,255,255,.12),rgba(255,255,255,.02));border:1px dashed rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;color:#b9c8dc;font-weight:700}
    .price{color:#cde2ff;font-weight:700;margin-top:8px}

    .footer{margin:48px 0 12px;display:flex;justify-content:space-between;align-items:center;color:#a8bad4}
    .footer small a{color:#a8bad4;text-decoration:underline}

    @media (max-width:920px){.hero{grid-template-columns:1fr}.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:520px){.features{grid-template-columns:1fr}.grid{grid-template-columns:1fr}}

    /* Teacher overlay for live UCB scores */
    .ucb-overlay{position:fixed;left:16px;bottom:16px;z-index:9999;background:rgba(15,27,43,.95);color:#e7f1ff;border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:10px 12px;min-width:240px;box-shadow:0 10px 30px rgba(0,0,0,.4);font:13px/1.4 ui-sans-serif,system-ui}
    .ucb-overlay h4{margin:0 0 6px;font-size:13px}
    .ucb-overlay table{width:100%;border-collapse:collapse}
    .ucb-overlay td{padding:2px 4px}
    /* ---- Live simulator board (bottom area) ---- */
    .liveboard { margin:32px auto 48px; max-width:1200px; background:#0f1b2b; border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:18px; }
    .liveboard h3 { margin:4px 0 10px; font-size:18px; }
    .liveboard .row { display:grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr; gap:8px; }
    .liveboard .cell { background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:10px; }
    .liveboard .kpi { font: 700 22px/1.2 ui-sans-serif, system-ui; }
    .liveboard small { color:#9fb0c3; }
    .liveboard table { width:100%; border-collapse:collapse; }
    .liveboard td { padding:6px 8px; border-bottom:1px dashed rgba(255,255,255,.08); }
    .liveboard td b { font-size:14px; }
    .liveboard .ok { color:#22c55e; }
    .liveboard .warn { color:#ffcf5a; }
    .liveboard .bad { color:#ff4d4f; }


    /* quick flash on update */
    @keyframes flash {
      0%   { background: rgba(255,255,255,0.00); }
      35%  { background: rgba(255,255,255,0.10); }
      70%  { background: rgba(255,255,255,0.00); }
      100% { background: rgba(255,255,255,0.00); }
    }
    .u-flash { animation: flash 0.8s ease-in-out 1; border-radius: 8px; }

    /* highlight the max U(i) */
    .u-max {
      box-shadow: 0 0 0 2px var(--accent), 0 0 22px var(--ring);
      border-radius: 8px;
    }
        /* ---- Center overlay for animated update ---- */
    .livepopup-backdrop {
      position: absolute; inset: 0; display: grid; place-items: center;
      background: rgba(5, 12, 20, 0.55);
      border-radius: 14px;
    }

    .livepopup {
      width: min(900px, 92vw);
      background: rgba(15,27,43,0.98);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      color: #e7f1ff;
    }

    .livepopup h4 {
      margin: 0 0 10px;
      font-size: 16px; letter-spacing: .3px;
    }

    .livepopup .grid {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
    }

    .livepopup .card {
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 12px;
    }

    .livepopup .arm {
      font-weight: 800; letter-spacing: .06em; opacity: .9; margin-bottom: 6px;
    }

    .livepopup .row {
      display: flex; justify-content: space-between; align-items: baseline;
      padding: 6px 0; border-bottom: 1px dashed rgba(255,255,255,.08);
    }
    .livepopup .row:last-child { border-bottom: none; }

    .livepopup .label { color: #9fb0c3; font-size: 12px; }
    .livepopup .val   { font-weight: 700; }

    .livepopup .u-max {
      box-shadow: 0 0 0 2px var(--accent), 0 0 22px var(--ring) inset;
      border-radius: 12px;
    }

    /* small helper for number pulse */
    @keyframes bump {
      0% { transform: scale(1); }
      40% { transform: scale(1.035); }
      100% { transform: scale(1); }
    }
    .livepopup .bump { animation: bump .6s ease-out 1; }
  </style>
</head>
<body>
  <div class="container" id="app">
    <header class="topbar">
      <div class="logo" aria-label="Brand">
        <div class="logo-mark" aria-hidden="true"></div>
        <span>ShopSmart</span>
      </div>
      <nav>
        <a href="#">Home</a>
        <a href="#">New</a>
        <a href="#">Deals</a>
        <a href="#">Support</a>
      </nav>
      <div class="switcher" aria-label="Variant switcher (teacher only)">
        <button class="pill" data-arm="A" title="Variant A – Free shipping">A</button>
        <button class="pill" data-arm="B" title="Variant B – 20% off">B</button>
        <button class="pill" data-arm="C" title="Variant C – New arrivals">C</button>
      </div>
    </header>

    <section class="hero">
      <div class="hero-card" id="hero-card">
        <span class="badge" id="badge">FREE SHIPPING</span>
        <div class="eyebrow" id="eyebrow">Variant A</div>
        <h1 class="title" id="title">Get it fast, ship it free.</h1>
        <p class="subtitle" id="subtitle">Order today and enjoy free, carbon‑neutral shipping on all orders — no minimum. Fresh picks curated for you.</p>
        <div class="cta-row">
          <button class="btn-primary" id="cta-primary">Shop now</button>
          <button class="btn-ghost" id="cta-secondary">Learn more</button>
        </div>
      </div>
      <div class="hero-card">
        <div class="img">Hero Image</div>
        <div class="features">
          <div class="feature"><h4>Fast delivery</h4><p>2–3 business days on most items.</p></div>
          <div class="feature"><h4>Trusted returns</h4><p>30‑day hassle‑free returns.</p></div>
          <div class="feature"><h4>Secure checkout</h4><p>PCI‑compliant & encrypted.</p></div>
        </div>
      </div>
    </section>

    <section>
      <h3>Recommended for you</h3>
      <div class="grid">
        <div class="card"><div class="img">Product</div><div class="price">$49.00</div></div>
        <div class="card"><div class="img">Product</div><div class="price">$59.00</div></div>
        <div class="card"><div class="img">Product</div><div class="price">$35.00</div></div>
        <div class="card"><div class="img">Product</div><div class="price">$89.00</div></div>
      </div>
    </section>

    <!-- Live simulator board (visible area for students/teacher) -->
    <section class="liveboard" id="liveboard">
      <h3>Live simulator — current round metrics</h3>
      <div class="row" style="margin-bottom:12px;">
        <div class="cell"><div class="kpi" id="k_t">t = 0</div><small>total rounds</small></div>
        <div class="cell"><div class="kpi" id="k_choice">choice = —</div><small>arm shown this visit</small></div>
        <div class="cell"><div class="kpi" id="k_last">last r = —</div><small>last reward (primary CTA)</small></div>
        <div class="cell"><div class="kpi" id="k_na">n_A = 0</div><small>impressions of A</small></div>
        <div class="cell"><div class="kpi" id="k_nb">n_B = 0</div><small>impressions of B</small></div>
        <div class="cell"><div class="kpi" id="k_nc">n_C = 0</div><small>impressions of C</small></div>
      </div>
      <div class="row">
        <div class="cell" style="grid-column: span 6;">
          <table id="utilTable">
            <tr><td><b>Arm</b></td><td>nᵢ</td><td>sᵢ</td><td>μ̂ᵢ</td><td>bonusᵢ = √((2 ln t)/nᵢ)</td><td><b>U(i) = μ̂ᵢ + bonusᵢ</b></td></tr>
            <tr id="rowA"></tr>
            <tr id="rowB"></tr>
            <tr id="rowC"></tr>
          </table>
        </div>
      </div>
    </section>

    <footer class="footer">
      <small>Students: each visit sees exactly one design (A/B/C), chosen by UCB on the server. Primary CTA click counts as reward r=1.</small>
      <small>Teacher: add <code>?teacher=1</code> to reveal simulator.</small>
    </footer>
  </div>

  <script>
    // ----------------------- Variants -----------------------
    const variants = {
      A:{eyebrow:'Variant A',badge:'FREE SHIPPING',title:'Get it fast, ship it free.',subtitle:'Order today and enjoy free, carbon‑neutral shipping on all orders — no minimum. Fresh picks curated for you.',primary:'Shop now',secondary:'Learn more'},
      B:{eyebrow:'Variant B',badge:'20% OFF TODAY',title:'Today only: 20% off everything.',subtitle:'Limited‑time savings at checkout. Discount auto‑applies — no code needed. While supplies last.',primary:'Get 20% off',secondary:'View details'},
      C:{eyebrow:'Variant C',badge:'NEW ARRIVALS',title:'New arrivals, just for you.',subtitle:'Fresh drops every week, curated to your style. Discover the latest picks before they sell out.',primary:'See what’s new',secondary:'Browse collections'}
    };

    const app = document.getElementById('app');
    const hero = {
      badge: document.getElementById('badge'),
      eyebrow: document.getElementById('eyebrow'),
      title: document.getElementById('title'),
      subtitle: document.getElementById('subtitle'),
      ctaP: document.getElementById('cta-primary'),
      ctaS: document.getElementById('cta-secondary')
    };

    function applyArm(arm){
      const v = variants[arm]; if(!v) return;
      app.classList.remove('arm-A','arm-B','arm-C'); app.classList.add('arm-'+arm);
      hero.badge.textContent = v.badge; hero.eyebrow.textContent = v.eyebrow;
      hero.title.textContent = v.title; hero.subtitle.textContent = v.subtitle;
      hero.ctaP.textContent = v.primary; hero.ctaS.textContent = v.secondary;
      document.querySelectorAll('[data-arm]').forEach(b=> b.classList.toggle('active', b.dataset.arm===arm));
      console.log(`[MAB] show arm=${arm}`);
    }

    // ----------------------- MAB state (mock server) -----------------------
    const KEY = 'mab_ucb_counts_v1';
    function loadState(){ try { return JSON.parse(localStorage.getItem(KEY)) || {A:{n:0,s:0},B:{n:0,s:0},C:{n:0,s:0},t:0}; } catch { return {A:{n:0,s:0},B:{n:0,s:0},C:{n:0,s:0},t:0}; } }
    function saveState(st){ localStorage.setItem(KEY, JSON.stringify(st)); }

    function pickArmUCB(st){
      const arms=['A','B','C'];
      for(const a of arms) if(st[a].n===0) return a; // warm start
      const t=Math.max(1,st.t); let best=arms[0], bestScore=-1;
      for(const a of arms){ const n=st[a].n, s=st[a].s; const mu=s/n; const bonus=Math.sqrt((2*Math.log(t))/n); const score=mu+bonus; if(score>bestScore){bestScore=score; best=a;} }
      return best;
    }

    // ----------------------- Per-visit serving (students) -----------------------
    let __last = { choice: '—', reward: '—' };
    function renderLiveBoard(){
      const st = loadState();
      const t = st.t || 0;
      const arms = ['A','B','C'];
      const rows = {A: document.getElementById('rowA'), B: document.getElementById('rowB'), C: document.getElementById('rowC')};
      document.getElementById('k_t').textContent = `t = ${t}`;
      document.getElementById('k_choice').textContent = `choice = ${__last.choice}`;
      document.getElementById('k_last').textContent = `last r = ${__last.reward}`;
      document.getElementById('k_na').textContent = `n_A = ${st.A.n}`;
      document.getElementById('k_nb').textContent = `n_B = ${st.B.n}`;
      document.getElementById('k_nc').textContent = `n_C = ${st.C.n}`;
      function fmt(x){ return (typeof x==='number' && isFinite(x)) ? x.toFixed(3) : (x===Infinity?'∞':'—'); }
      for(const a of arms){
        const n = st[a].n || 0, s = st[a].s || 0;
        const mu = n ? (s/n) : 0;
        const bonus = n ? Math.sqrt((2*Math.log(Math.max(1,t)))/n) : Infinity;
        const u = (n? (mu + bonus) : 'warm-up');
       rows[a].innerHTML =
        `<td><b>${a}</b></td>`+
        `<td>${n}</td>`+
        `<td>${s}</td>`+
        `<td>${fmt(mu)}</td>`+
        `<td>${fmt(bonus)}</td>`+
        `<td id="u-${a}"><b>${typeof u==='string'?u:fmt(u)}</b></td>`;

      }
    }

   


      // ----------------------- Per-visit serving (students) -----------------------
      (function serveOnce(){
        const params    = new URLSearchParams(location.search);
        const isTeacher = params.get('teacher') === '1';

        const switcher = document.querySelector('.switcher');
        if (switcher) switcher.style.display = isTeacher ? 'flex' : 'none';

        const st = loadState();
        st.t += 1;

        const chosen = isTeacher ? (params.get('arm') || pickArmUCB(st)) : pickArmUCB(st);

        applyArm(['A','B','C'].includes(chosen) ? chosen : 'A');
        st[chosen].n = (st[chosen].n || 0) + 1;
        saveState(st);

        __last.choice = chosen;
        __last.reward = '—';
        renderLiveBoard();

        // ---------- reward + animation + reload ----------
        let visitReward = 0;
        let reloaded = false;


  function credit(award, label){
      award = Math.max(0, Math.min(1, award));
      const delta = award - visitReward;
      if (delta <= 0) return;

      // snapshot BEFORE update
      const before = loadState();

      visitReward = award;

      // apply update
      const after = structuredClone(before);
      after[chosen].s = (after[chosen].s || 0) + delta;
      // NOTE: t and n already bumped earlier in serveOnce
      saveState(after);

      __last.reward = visitReward;
      renderLiveBoard();
      console.log(`[MAB] ${label} click -> award=${award}, delta=${delta}, arm=${chosen}`);

      if (!reloaded) {
        reloaded = true;
        // animate from 'before' to 'after' in the center board, then reload
        animateAndReload(before, after, 3200);
      }
    }
    

    // Primary = 1.0
    if (hero.ctaP) {
      hero.ctaP.addEventListener('click', () => {
        credit(1.0, 'primary');
        alert(`✅ Conversion tracked for arm ${chosen} (r=1.0)`);
      });
    }

    // Secondary = 0.5
    if (hero.ctaS) {
      hero.ctaS.addEventListener('click', () => {
        credit(0.5, 'secondary');
        alert(`ℹ️ Partial conversion tracked for arm ${chosen} (r=0.5)`);
      });
    }

    // ----- Helper: compute metrics for an arm -----
    function armMetrics(state, arm){
      const t = Math.max(1, state.t);
      const n = state[arm].n || 0;
      const s = state[arm].s || 0;
      const mu = n ? (s / n) : 0;
      const bonus = n ? Math.sqrt((2 * Math.log(t)) / n) : 0;
      const u = mu + bonus; // during warm-up we already warmed each arm once
      return { n, s, mu, bonus, u };
    }

    // ----- Build overlay and animate numbers for ALL arms, then highlight max and reload -----
function animateAndReload(stateBefore, stateAfter, durationMs){
  const board = document.getElementById('liveboard');
  if (!board) { location.reload(); return; }

  // Backdrop + card
  const backdrop = document.createElement('div');
  backdrop.className = 'livepopup-backdrop';
  const pop = document.createElement('div');
  pop.className = 'livepopup';
  pop.innerHTML = `
    <h4>Updating utilities U(i) = μ̂ᵢ + bonusᵢ (Chernoff–Hoeffding width)</h4>
    <div class="grid">
      ${['A','B','C'].map(a => `
        <div class="card" id="card-${a}">
          <div class="arm">ARM ${a}</div>
          <div class="row"><span class="label">μ̂</span><span class="val" id="mu-${a}">0.000</span></div>
          <div class="row"><span class="label">bonus</span><span class="val" id="bo-${a}">0.000</span></div>
          <div class="row"><span class="label"><b>U(i)</b></span><span class="val" id="uu-${a}">0.000</span></div>
        </div>
      `).join('')}
    </div>`;
  backdrop.appendChild(pop);
  board.style.position = 'relative';
  board.appendChild(backdrop);

  const arms = ['A','B','C'];

  // metrics helper
  function metrics(st, arm){
    const t = Math.max(1, st.t);
    const n = st[arm].n || 0;
    const s = st[arm].s || 0;
    const mu = n ? (s / n) : 0;
    const bonus = n ? Math.sqrt((2 * Math.log(t)) / n) : 0;
    return { n, s, mu, bonus, u: mu + bonus };
  }

  // START = stateBefore (already includes impression + t for this page view)
  const start = Object.fromEntries(arms.map(a => [a, metrics(stateBefore, a)]));

  // END = **next-decision moment**: use stateAfter but set t' = t + 1,
  // so bonuses shrink for ALL arms (and μ̂ is the post-click mean for the chosen arm).
  const endState = structuredClone(stateAfter);
  endState.t = (stateAfter.t || 0) + 1;
  const end = Object.fromEntries(arms.map(a => [a, metrics(endState, a)]));

  // lerp helpers
  const clamp = (x,min,max)=>Math.max(min,Math.min(max,x));
  const lerp  = (a,b,t)=> a + (b-a)*t;
  const fmt   = x => Number.isFinite(x) ? x.toFixed(3) : '—';

  const startTs = performance.now();
  function frame(ts){
    const p = clamp((ts - startTs) / durationMs, 0, 1);
    arms.forEach(a => {
      const mu = lerp(start[a].mu,   end[a].mu,   p);
      const bo = lerp(start[a].bonus,end[a].bonus,p);
      const uu = lerp(start[a].u,    end[a].u,    p);
      const muEl = document.getElementById(`mu-${a}`);
      const boEl = document.getElementById(`bo-${a}`);
      const uuEl = document.getElementById(`uu-${a}`);
      if (muEl) { muEl.textContent = fmt(mu); muEl.classList.add('bump'); }
      if (boEl) { boEl.textContent = fmt(bo); boEl.classList.add('bump'); }
      if (uuEl) { uuEl.textContent = fmt(uu); uuEl.classList.add('bump'); }
    });

    if (p < 1) {
      requestAnimationFrame(frame);
    } else {
      // highlight argmax U at end state
      let bestArm = 'A', bestU = -Infinity;
      arms.forEach(a => { if (end[a].u > bestU) { bestU = end[a].u; bestArm = a; } });
      const bestCard = document.getElementById(`card-${bestArm}`);
      if (bestCard) bestCard.classList.add('u-max');
      setTimeout(() => { location.reload(); }, 900);
    }
  }
  requestAnimationFrame(frame);
}
  })();




  


    setInterval(renderLiveBoard, 800);

    // ----------------------- Teacher-only simulator -----------------------
    (function teacherOnly(){
      const params=new URLSearchParams(location.search); const isTeacher=params.get('teacher')==='1'; if(!isTeacher) return;

      // Overlay with live UCB numbers
      const overlay=document.createElement('div'); overlay.className='ucb-overlay'; overlay.innerHTML=`<h4>UCB (teacher)</h4><div id="ucbRows"></div>`; document.body.appendChild(overlay);
      function renderOverlay(){
        const st=loadState(); const t=Math.max(1,st.t);
        const rows=['A','B','C'].map(a=>{ const n=st[a].n||0, s=st[a].s||0; const mu=n? s/n:0; const bonus=n? Math.sqrt((2*Math.log(t))/n):'∞'; const score=n? (mu+bonus):'warm-up'; return `<tr><td><b>${a}</b></td><td>n=${n}</td><td>s=${s}</td><td>μ̂=${mu.toFixed(3)}</td><td>bonus=${bonus==='∞'?'∞':bonus.toFixed(3)}</td><td>score=${typeof score==='string'?score:score.toFixed(3)}</td></tr>`; }).join('');
        overlay.querySelector('#ucbRows').innerHTML = `<table>${rows}</table>`;
      }
      setInterval(renderOverlay, 600); renderOverlay();

      // Control panel
      const panel=document.createElement('div'); panel.style.cssText='position:fixed;right:16px;bottom:16px;z-index:9999;background:rgba(15,27,43,.95);color:#e7f1ff;border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:12px 14px;width: 320px;box-shadow:0 10px 30px rgba(0,0,0,.4);font:13px/1.4 ui-sans-serif,system-ui';
      panel.innerHTML=`
        <div style="font-weight:700; margin-bottom:6px;">Simulator (teacher)</div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:6px;">
          <label>Rounds <input id="simN" type="number" min="1" value="200" style="width:80px"></label>
          <button id="btnRun" style="padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.2); background:#22c55e; color:#05180e; font-weight:700; cursor:pointer;">Run</button>
          <label>CTR A <input id="ctrA" type="number" step="0.001" min="0" max="1" value="0.040" style="width:80px"></label>
          <label>CTR B <input id="ctrB" type="number" step="0.001" min="0" max="1" value="0.060" style="width:80px"></label>
          <label>CTR C <input id="ctrC" type="number" step="0.001" min="0" max="1" value="0.090" style="width:80px"></label>
          <button id="btnReset" style="padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.2); background:#ff4d4f; color:#2b0607; font-weight:700; cursor:pointer;">Reset</button>
        </div>
        <div id="simOut" style="margin-top:6px; color:#c9d9ee;"></div>
      `;
      document.body.appendChild(panel);

      const $ = sel => panel.querySelector(sel);
      function bernoulli(p){ return Math.random()<p ? 1:0; }

      $('#btnRun').addEventListener('click',()=>{
        const N=Number($('#simN').value||'0'); const ctr={A:Number($('#ctrA').value),B:Number($('#ctrB').value),C:Number($('#ctrC').value)}; const arms=['A','B','C']; let st=loadState();
        // ensure warm-up
        for(const a of arms) if(st[a].n===0){ st.t+=1; st[a].n+=1; }
        saveState(st);
        let clicks=0; for(let r=0;r<N;r++){ st=loadState(); st.t+=1; const a=pickArmUCB(st); st[a].n+=1; const rw=bernoulli(ctr[a]); if(rw){ st[a].s+=1; clicks++; } saveState(st); }
        const A=loadState(); const fmt=a=>`${a}: n=${A[a].n}, s=${A[a].s}, μ̂=${(A[a].s/Math.max(1,A[a].n)).toFixed(3)}`;
        $('#simOut').textContent=`Ran ${N} rounds. Total clicks=${clicks}. [ ${fmt('A')} | ${fmt('B')} | ${fmt('C')} ]`;
      });

      $('#btnReset').addEventListener('click',()=>{ localStorage.removeItem(KEY); $('#simOut').textContent='State reset.'; });
    })();
  </script>
</body>
</html>
